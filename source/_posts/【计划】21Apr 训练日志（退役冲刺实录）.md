---
title: '21Apr 训练日志（退役冲刺实录）'
date: 2021-04-30 23:59:59
tags: 
mathjax: true
encrypt: true
---

### 鱼人节快乐！

橙蓝紫红灰橙红——某谷给我的颜色！

### 男人八题

单写。

### Noionline

单写。

## $\mathcal{4.2}$

### $XJOI1724$

#### $T1$

先手第一次操作前，树被划成了若干连通块。

奇数点的连通块一定先手赢：一个点的连通块显然先手；否则后手划一条边把连通块割成一奇一偶，归纳可证。（若 n 为奇数，先手赢）

偶数麻烦。考虑染叶子，这个策略很优：

1. 是链：
    - 长度 $\geq 4$：先手选叶子，后手只能选叶子父亲，转为奇数，先手赢；
    - 长度为 $2$：后手赢
3. 不是链：一定存在一个最低分叉点 $v$ 有 $\geq 2$ 个儿子
    - $v$ 子树中有除 $v$ 以外的非叶节点：若先手染叶子，后手就要染该叶子的父亲，那减少了三个空点，转为奇数，先手赢；
    - $v$ 儿子全是叶子：先手染 $v$，后手无论如何操作都无法一次染色所有 $v$ 的儿子，先手赢。

综上所述，当且仅当 $n$ 为偶数且树存在完美匹配且 $K \geq n / 2 - 1$ 时后手赢。

直观理解，先手选一个叶子 $x$，强迫后手选叶子父亲 $y$ 同时断掉 $y$ 的其他边否则就一次染三个，转为奇数了。但是这个很难直接想到嘛…… 还是乖乖分讨吧。讲真分讨也是挑角度的，我咋就不会做呢…… 我们班一大堆胡出来结论不会证的= = 羡慕了

#### $T2$

放在三维平面上，segment tree beats 裸题；还有更好的做法吗？hhz 来㗅了一嘴：$O(n)$ 做法简单又好写：选一维，这一维方向的立方体从头到尾都顶着，拍成二维台阶状；另外两维你发现就是删一个前缀/后缀。双端队列即可。

#### $T3$

十分清真的生成函数！

$ans = \frac{n!}{K^n} [x^n] ( \sum\limits_{i \geq 0} \frac{i^F x^i}{i!} )^L e^{(K - L)x} x^i$

化下降幂：

$\sum\limits_{i \geq 0} \frac{i^F x^i}{i!} = \sum\limits_{j = 0}^F { F \brace j } x^j e^x$

多项式快速幂算出来这个多项式，设为 $\sum\limits_{i \geq 0} a_i x^i$

$ans = \frac{n!}{K^n} \sum\limits_{i = 0}^n a_i [x^{n - i}] e^{kx}$

$= \frac{n!}{K^n} \sum\limits_{i = 0}^n a_i \frac{K^{n - i}}{(n - i)!}$

$= \frac{1}{K^n} \sum\limits_{i = 0}^n a_i \frac{K^{n - i}}{n^{\underline{i}}}$

保证了 $FL \leq 5e4$，直接做就是对的。

### [$CF623E$（缺代码）](https://www.luogu.com.cn/problem/CF263E)

$dp_{i, j} = \sum\limits_{k = 1}^j dp_{i - 1, j - k} \binom{j}{k} 2^{j - k}$

EGF：$dp_i(x) = dp_{i - 1}(2x) (e^x - 1)$

归纳：$dp_1(x) = e^x - 1$，$dp_2(x) = (e^x - 1)(e^{2x} - 1)$ $\cdots$ $dp_n(x) = \prod\limits_{i = 0}^{n - 1} (e^{2^ix} - 1) = \sum\limits_{i = 0}^{2^n - 1} (-1)^{cnt(i)} e^{ix}$

$ans = [x^k] e^x dp_n(x) = [x^k] \sum\limits_{i = 0}^{2^n - 1} (-1)^{cnt(i)} e^{(i + 1)x} = \sum\limits_{i = 0}^{n - 1} (-1)^{cnt(i)} (i + 1)^k$

设 $f(n, k, 0) = \sum\limits_{i = 0}^{n - 1} [cnt(i) \mod 2 = 0] (i + 1)^k$，$f(n, k, 1) = \sum\limits_{i = 0}^{n - 1} [cnt(i) \mod 2 = 1] (i + 1)^k$

倍增 FFT 即可算出 n 特别特别大的答案！！

要 任 意 模 数 NTT，咕了

### [$CF1349D-slime\ and\ biscuits$](https://www.luogu.com.cn/problem/CF1349D)

绝对有意思的题。这是一个停时问题（我不会鞅和停时定理啊QAQ）看题解去了…… **势能法**比概率做法不知道高到**哪里**去了！

我们希望构造势能函数 $f$，使得每操作一步，$\sum\limits_{i = 1}^n f(a_i)$ 就减少 $1$。（真是神奇的定义啊）

$ans = 初势能 - 末势能 = ( \sum\limits_{i = 1}^{n} f_{a_i} ) - ( f_m + f_0 (n - 1) )$。也就是说 $\sum\limits_{i = 1}^n f_{a_i}$ 要比后继的期望大 $1$。即 $\sum\limits_{i = 1}^n f_{a_i} = \frac{1}{m} \sum\limits_{i = 1}^n a_i ( f_{a_i - 1} + \sum\limits_{j \neq i} (\frac{1}{n - 1} f_{a_j + 1} + \frac{n - 2}{n - 1} f_{a_j}) )$。化得 $\sum\limits_{i = 1}^n f_{a_i} = \sum\limits_{i = 1}^n \frac{a_i}{m} ( f_{a_i - 1} + 1 ) + f(a_i + 1) \frac{m - a_i}{m(n - 1)} + f(a_i) \frac{(n - 2)(m - a_i)}{(n - 1)m}$

再强调一次，是**构造**，怎么方便怎么来。强制钦定每个 $i$ 左右项都相等，则 $f(a) = \frac{a}{m} ( f(a - 1) + 1 ) + f(a + 1) \frac{m - a}{m(n - 1)} + f(a) \frac{(n - 2)(m - a)}{(n - 1)m}$。

这种和相邻若干项有关的方程组叫做 band-matrix。方程组个数为 $n$、与相邻 $d$ 项有关的 band-matrix 消元复杂度是 $O(nd^2)$，大概是竖着消且只消那 $d$/$2d$ 项？[点我](https://www.luogu.com.cn/blog/froggy/qian-tan-gao-si-xiao-yuan-ta-zhan-zhi-band-matrix)

另一种方便的解法是设 $f(i) = k_i f(m) + b_i$。钦定 $f(m - 1) = 0$，解出 $f(0 \cdots m - 2)$，根据 $f(0) = f(1)$ 再推回来。

[$Code$](https://codeforces.com/contest/1349/submission/111783801)

## $\mathcal{4.3}$

### $XJOI1725$

今天题太神了= = 很抱歉我只订了 T1

#### $T1$

好神哦，正解！考虑连辅助边 $(2k + 1, 2k)$, $k \in [0, n / 2]$，那么每组匹配和辅助边共同形成了若干偶环和奇链的并（奇环不可能存在），同时一种偶环和奇链的并对应恰好一组匹配和辅助边（显然），那么 dp 出合法的偶环和奇链的方案，集合幂级数 exp 合并即可。

把 $2k + 1$ 和 $2k$ 视作一个点，一个点看作奇链。$O(2^{n/2} n^2)$。

$c$ 怎么算呢？一个大小为 $x$ 的奇链，贡献 $c^{x - 1}$；一个大小为 $x$ 的环，贡献 $c^x$，因此往每条链的贡献里乘上 $1/c$。

去复习了一遍集合幂级数 exp。我又悟了。

### $LibreOJ Round\ 9$

单写

## $\mathcal{4.5}$

### UR 20

单写

### $XJOI1726$

#### $T1$

我常常因为不够乱搞而和大家格格不入。

将空间分成 $B * B$ 个块，$n$ 条直线每条经过 $B$ 个块，平均每个块 $O(n / B)$ 条直线。$B$ 取 $\sqrt{n}$ 或者更小即可。

论随机数据的正确打开方式！！！

#### $T2$

lyndon 的相关 theories……

当前 lyndon words 被划分成若干字典序递增的部分

考虑找下一个 lyndon words 怎么找：
1. 当前长度为 $m$：类似 $m$ 进制数的进位。
2. 将之前的前缀复制到末尾后 $+1$ 因为要保证字典序递增。

#### $T3$

不过如此，套路题，~~我只会积分~~。主要是第一步就错了啦：$(\sum x_i)^k$ 不拆，其实只要保证每个 $x_i$ 的次方中 $x_i$ 的取值不变即可。

所以 $ans_k = E((\sum x_i)^k) = \sum\limits_{\sum p_i = k} \binom{k}{p_1, \cdots, p_i} \prod_i ( E(x_i^{p_i}) )$

套路的，后面那个 $E$ 我们积一下：

$E(x_i^{p_i}) = \frac{1}{a_i} \int_0^{a_i} t^{p_i} dt = \frac{a_i^{p_i}}{p_i + 1}$

拆开组合数，$ans_k = k! \sum\limits_{\sum p_i = k} \prod_i \frac{a_i^{p_i}}{p_i + 1}$

生成函数拍你脸上。

设 $F(x) = \sum_i \frac{x^i}{(i + 1)!}$

$ans_k = k! [x^k] \prod_i F(a_i x)$

~~诶如果把 $F(x)$ 看作 $\frac{e^x}{x}$ 那 $ans = \frac{k!}{\prod a_i} [x^{k + n}] e^{x \sum a_i}$ 那不是直接算嘛？？~~

~~$\mathscr{Naive}$! $F(x) = \frac{e^x - 1}{x}$。~~

套路：取对数（$\ln$），乘积变 $\sum$，求出 $\ln$ 后再 $\exp$ 回去就得到乘积啦

设 $G = \ln F$

$\sum G(a_ix) = \sum_i \sum_j g_j (a_ix)^j = \sum_j g_j x^j \sum_i a_i^j$，后面这个 $\sum$ 显然是 $\sum_i \frac{1}{1 - a_i x}$，可以通分后分治 NTT 求分子分母，再求逆。

再 $\exp(G)$ 就得到了 $[x^{1 \cdots m}]$ 的所有系数。

### 关于省选

没错这是篇小作文。xml 没有省选资格但是多亏 xj 的东道主身份得以体验。~~wjh 刚刚灌了一大缸鸡汤。~~ 过去一年里其实 xml 不是每时每刻的状态都很好的，zy 的不定时颓废情绪多少影响到了我…… ~~所以一年下来啥都学了些皮毛，难过……~~ wjh 的鸡汤还是要冷静喝，女生目前是少，但一茬茬出的呀，机会——客观来说还是渺茫的。我对于拿约进队的执念已经没什么了，就是想不留遗憾嘛，CF 上紫名（熬夜也打！），AT 再往高走走qwq，UOJ 再绿一点……（雾）最后的几场 NOI 赛事发挥出水平就不留遗憾了。想变强！

从今以后每道题代码自己写，写不出来宁愿鸽在 todo-list 里。

## $\mathcal{4.6}$

### UR 19

单写

### [清训-V](https://uoj.ac/problem/164)

写一棵线段树，支持 区间加 $a$、区间减 $a$（对 $0$ 取 $\max$）、区间赋值 $a$、单点查询、单点历史最大值。

设 $x$ 位置的值为 $f(x)$，历史最大值为 $g(x)$

我们需要神奇的 struct~ 将操作写为 $\max(x + a, b)$。前三种操作分别为 $(a, -\infty)$、$(-a, 0)$、$(-\infty, a)$。

如何合并 $(a, b)$ 和 $(c, d)$？
- $\max(\max(x + a, b) + c, d) = \max(x + a + c, \max(b + c, d))$，即 $(a, b) * (c, d) = (a + c, \max(b + c, d))$

如何维护历史最值？
- 显然 $g(x)$ 也是 $\max(x + a, b)$ 的形式。那么给 struct 再增加两位即可（

$x\{a, b, mxa, mxb\} + y\{a, b, mxa, mxb\} =$

$\{max(x.a + x.b, -\infty),$

$max(x.b + y.a, y.b),$

$max(x.mxa, x.a + y.mxa),$

$max(x.mxb, max(y.mxb, y.mxa + x.b))\}$

[$Code$](https://uoj.ac/submission/467337)

### [链式反应](https://uoj.ac/problem/50)

题意人言否？= = 数树，其中每个点 $x$ 有 $c + 2$ 个儿子，其中 $c$ 个叶子，$c \in A$

$f(i) = \frac{1}{2} \sum\limits_j \sum\limits_k \binom{i - 1}{j} \binom{i - 1 - j}{k} f(j) f(k)$

设 $g(i) = \sum_j \frac{f(j)}{j!} \frac{f(i - j)}{(i - j)!}$，那么 $\frac{2f(i)}{(i - 1)!} = \sum\limits_{p = j + k} g(p) [i - 1 - p \in A]$

当我们用 $g$ 和 $h$ 去卷 $f$（这里只是临时变量，不是上面的 $fgh$）时，$f_i = \sum\limits_{j + k = i} g_j h_k$。考虑分治 NTT，即计算所有 $j \in [l, mid]$ 对所有 $i \in [mid + 1, r]$ 的贡献。
需要注意的是 $k < l$ 时**不会**重复计算，系数额外乘 $2$ 与之后的 $\frac{1}{2}$ 抵消。

[$Code$](https://uoj.ac/submission/467359)

### [新年的追逐战](https://uoj.ac/problem/498)



### SNOI2020

单写

## $\mathcal{4.7}$

### $XJOI1727$

最近的省选训练都好神啊！

#### $T1$

~~想了半天数论做法，GG~~

$C = \{0 ~ s - 1\}$ 意味着 $0$ ~ $s - 1$ 的每个数只能被唯一表示， 可以利用这个限制来找点性质。

正解是考虑每次往 $A$/$B$ 加一个数。我们称不是复制而成的段为 $1$ 段。
那么加数的过程大概就是，加若干 $1$ 段，再把 $1$ 段复制若干份，再加若干 $1$ 段……

设 $f(n, m)$ 表示 $1$ 段个数为 $n$，复制次数为 $m$，那么 $(n, m)$ 可以转移到 $(n * d, m)$（重复 $d - 1$ 次加 $n$ 个 $1$ 段的操作）或者 $(n, m * d)$（重复 $d - 1$ 次复制 $m$ 次的操作）~~不懂就画数轴，手玩小数据~~

那么假设 $A$ 都是复制操作，$B$ 就是加 $1$ 段操作了。我们要求 $f(s / m, m)$。

$f(n, m) = \sum\limits_{d \mid n, d \neq 1} f(m, n/d)$，边界 $f(x, 0) = 1$。

发现在给 $n$、$m$ 交替除因子，那么质因数分解 + 插板法 + 容斥，保证每次至少除一个即可。

#### $T2$

不合法情况是出现了：
```
0 xxx 0
1 xxx 1
```

- 每个 $0$ 段长度极差 $\leq 1$。因为如果 10001 和 101 同时出现就不合法了。
- 不同的**长度相同**的连续段中，长段（短段）数量之差 $\leq 1$。否则不合法情况中两端就俩长段了。

发现把长段看作 $1$，短段看作 $0$，就存在缩小问题规模的子问题关系了。

$f(n, x)$ 表示长度为 $n$ 的串个数，其中 $x$ 个 $1$，钦定第一个位置一定是 $1$，最后一个位置一定是 $0$，那么有：$f(n, x) = f(x, n \mod x)$

从这可以发现，长度为 $n$ 的一定个数 $1$ 的串都是“确定”的——准确的说，它们循环同构。

枚举 $x$，dfs 找出所有 $x$ 个 $1$ 的串，总共就 $n^2$ 级别。bitset 判断其所有循环同构形式是否符合给定位置限制即可。$O(n^3 / \omega)$

#### $T3$

行列式那个逆序对的组合意义：$= \sum (-1)^{环 + n}$

$x = 0$: 划成环，只能是二元环或者自环，树形 dp
$x > 0$: 矩阵中当前行减第一行，行列式必然是 $ax + b$ 的形式，体现在树上就是可以任选一条路径组成环，剩下的还是在 $x = 0$ 树上选

dp, 六种状态。

代码待补。不是咕！upd: 已补。

## $\mathcal{4.8}$

### $XJOI1728$

#### $T1$

记录一下我的垃圾单 $log$ 线段树做法：首先性质是 $(i, j)$ 只会选与 $i + 1$ 同列的和与 $j + 1$ 同行的点，那么扫描线 + 线段树预处理每个位置能到达的最上和最右位置（具体来说倒着插入和删除，你发现这样插入的权值递减，所以线段树每个节点维护 vector 和指针，删除就在 ban 数组上标记，查询就懒惰的将指针后移、跳过那些 ban 掉的值，这样是一只 $log$），倒做，新建一棵线段树维护即可。本地不开 O2 11 s，逊爆了！

考虑优化：最后那步其实可以单调队列正做；现在瓶颈在于找最上和最右位置时的删除操作。

实际上「最上和最右」这俩属性是单调递增的，不删除也不会影响最优解被选取。单调队列即可。就线性啦！

~~论陷入误区的时候 xml 有多刚，直接刚 $log$ =_=||~~

#### $T2$

如果有三元环，一定是 $(0, L/2, L)$；否则都是跨越 $L/2$ 的对，即是一个二分图。

#### $T3$

如果没有换根，对 $x$ 执行集体移儿子操作可以建 $x$ 的虚点，把儿子都连到虚点然后移虚点即可；对 $x$ 执行集体移孙子操作可以找所有 $x$ 的**非叶子**儿子 $y$，对 $y$ 执行集体移儿子操作，可以证明这样复杂度均摊 $log$（LCT 的 $log$），因为每次叶子个数 $+1$，总共 $+n$。LCT 节点维护三个信息：splay 子树大小，实际子树大小，子树答案和。由于有 rev，需要翻倍，即记录六个信息。

考虑换根，虚点的做法就假掉了，[进来了解 ETT](https://blog.csdn.net/luositing/article/details/104793625)，hhz：ETT 维护树链剖分，LCT 照常做。我选择咕掉 ~~省选前最后一场，何必把心态搞爆呢 qwq~~

### [15互测-最大异或和](https://uoj.ac/problem/91)

维护的是**全局**线性基。

$Span\{v_1, \cdots, v_n\} = Span\{v_1, v_2 - v_1, \cdots, v_n - v_{n - 1}\}$

那么区间异或变成单点异或，区间赋值变成单点异或 + 区间清零。单点异或对于线性基来说可以看作删除 + 插入。

带删除线性基，和「圆环」那道一样搞搞。

[$Code$](https://uoj.ac/submission/467879)

### [神经网络](https://loj.ac/p/3102)

两棵树的任意路径可以拼起来，问题转化为把每棵树分割为若干条链，并且链排列在一块儿时相邻链的颜色不同。

如果没有这个限制就直接 EGF 卷起来。

考虑容斥：至少 $i$ 个相邻对相同，那么算好容斥系数再卷起来即可。

设 $F_i(x)$ 为第 $i$ 棵树 $f_{x, num, 0/1/2}$ 的 EGF（当然关于 $num$）啦

$F_i(x) = \sum\limits_{j = 1}^{k_i} f_j j! \sum\limits_{p = 0}^{j - 1} (-1)^p \binom{j - 1}{p} \frac{x^{j - p}}{(j - p)!}$

但是要求从第一棵树的第一个节点出发，第一棵树的 EGF 要魔改一发，即钦定第一个点所处的链位于首位

$F_1(x) = \sum\limits_{j = 1}^{k_1} f_j (j - 1)! \sum\limits_{p = 0}^{j - 1} (-1)^p \binom{j - 1}{p} \frac{x^{j - p - 1}}{(j - p - 1)!}$

因为是哈密顿**回路**，最后一条链不可以属于第一棵树，因此要减去这样的方案数，即最后一条链不参与卷积的方案数：

$\sum\limits_{j = 1}^{k_1} f_j (j - 1)! \sum\limits_{p = 0}^{j - 2} (-1)^p \binom{j - 1}{p} \frac{x^{j - 2 - p}}{(j - 2 - p)!}$

这时的 $p$ 若取到 $j - 1$，就会产生 $x^{-1}$ 项，无意义，所以 $p$ 到 $j - 2$ 即可。

把 $F_i$ 都卷起来，系数都加起来。

应该是比较直观且套路的做法？~~一道套路题我写了一个半小时没谁了，写挂多处，状若 sb~~

[$Code$](https://loj.ac/s/1112462)

## $\mathcal{4.9}$

### UNR #3

单写

### [$LOJ6669$](https://loj.ac/p/6669)

这题贼有意思。已知 $1$ 是根，先 $n$ 次询问得到所有点的深度。按深度从浅到深确定，维护重链，每次询问当前点与当前重链底端的距离，这样就确定了 $lca$ 的深度，那么再跳到 $lca$ 的重链…… 如此递归即可。询问次数 $O(nlogn)$，复杂度 $O(n^2)$ 因为要维护重链。

[$Code$](https://loj.ac/s/1113233)

## $\mathcal{4.12}$

省选爆蛋啦。

### JOI 做了几道

写在「JOI」。

### [幼儿园唱歌题](https://loj.ac/p/6626)

把后缀倒过来，想到反建，但是必须得在同一个 PAM 上呀？那把 $S^R$ 接到 $S$ 后即可。查询就跳 LCA。注意如果 lca 长度超了还要再跳。

[$Code$](https://loj.ac/s/1115350)

### 支配树模板

写在「支配树」。

## $\mathcal{4.13}$

### 前夕

写在「反演杂烩」。

### JOI 又做了几道

写在「JOI」。

### SGTBeats 模板

写在「Beats」。

---

对，又是我，我又来写小作文了。最近退役气氛好浓啊 /dk（可能只有我这么觉得）省选拿的一点点可怜低分甚至没有班上其他同学的一半，和几个还不错的同学也差了 100 分左右，好挫败啊 /dk 明明我这么努力为什么考场降智这么严重。怎么会落到这步境地呢…… ~~或许我该从身后的窗户跳下去结束我这傻逼的一生（危）~~

OI 是投入一万点都不一定收回一点，whk 是投入一点收一点，我想看书嘛 /dk 正常高中生的生活（退役生活）有什么不好嘛 /dk

五月以后大概就退役了，所以退役生活到时候管够，现在还是珍惜能搞 OI 的每一天吧！接下来写题都自己写，自己想。想不出来就 tm 不能写。

---

### [随机立方体](https://www.luogu.com.cn/problem/P5400)

设 $f_i$ 表示至少 $i$ 个极大值的概率。枚举极大值的大小顺序，所以是排列而不是组合。$f_i = P_n^i P_m^i P_l^i \prod\limits_{j = 1}^i \frac{1}{S_j}$，其中 $S_j$ 是 $j$ 个极大值的控制体积并。为什么是这样呢，我们已经考虑了顺序所以只有我是当前体积并里的最大值时我才算极大值。$S_j = nml - (n - j)(m - j)(l - j)$，用「希望」中线性求逆元的方法即可。[$Code$](https://loj.ac/s/1115905)

### 万能欧几里得

写在「类欧几里得」。

## $\mathcal{4.14}$

### [青蕈领主](https://loj.ac/p/2554)

注意，是排列……

极长连续段是不会「相交但不包含」的。反证：$[l1, r1]$ $[l2, r2]$ $(l1 < l2)$ 相交但不包含，$[l1, r2]$ 一定是个极长连续段，与极长连续段定义矛盾。

所以包含关系是个树形结构。（类析合树结构）

- 设 $f(n)$ 表示 $L_i = 1 (i \in [1, n])$ 的 $n + 1$ 阶排列数量。（换个角度来看，就是所有连续子段都包含末尾元素的排列数）
- 设 $dp[l, r]$ 表示 $[l, r]$ 区间的方案数，$[l, r]$ 有 $k$ 个儿子 $[p_0, p_1 - 1] \cdots [p_{k - 1}, p_k - 1]$, $dp[l, r] = f(k) \prod dp[p_j, p_{j + 1} - 1]$ 因为抽象后的连续区间原来也是连续区间，而抽象后不连续的原来也不连续。
- 设 $son_i$ 表示以 $i$ 区间结尾的极长连续段儿子个数，$ans = dp[1, n] = \prod f_{son_i}$

所以怎么求 $f$？

考虑加入最小值（下面认为是 $1$）来从 $n$ 阶排列得到 $n + 1$ 阶排列。
1. 原序列合法，$1$ 只要不插在 $2$ 旁边即可。
2. 原序列不合法。加入 $1$ 变合法只有一种情况就是，原来的极长连续段不经过 $2$，插入 $1$ 后该段所有连续子段不复存在，且全局也不存在长度大于 $1$ 的极长连续段。

    设极长连续段值域为 $[x, x + l - 1]$。

    极长连续段自己的方案数怎么算呢？我们希望 $1$ 破坏它所有的连续子段。

    把 $1$ 看作 $l + 1$，$x$ ~ $x + l - 1$ 看作 $1$ ~ $l$，我们希望算出所有连续子段都经过最大值 $l + 1$ 的方案数。

    哦~ 上帝，方案数就是 $f(l)$！

    为什么啊！

    考虑排列 $a$ 的逆 $b_{a_i} = i$，发现 $a$ 中一个下标为 $[l, r]$ 值域为 $[a_l, a_r]$ 的子段到 $b$ 中就变成下标为 $[a_l, a_r]$ 值域为 $[l, r]$ 的子段，即 $a$ 和 $b$ 中连续段一一对应。

    **$a$ 中包含末尾元素的连续子段对应 $b$ 中所有包含最大值的连续子段。**

    这恰巧就是 $f$ 的定义。

    （这一步真的是很妙！不懂在考场上做出这题的人的脑回路…… T T）

    剩下的就好办了，
    把极长连续段看作一个元素，和剩下的 $n - l$ 个元素方案数为 $f(n - l)$
    $x > 2$ 且 $x + l - 1 < n + 1$，$x$ 有 $n - l - 1$ 种取值。枚举 $l$。

因此柿子为：
$f(0) = 1$, $f(1) = 2$

$f(n) = (n - 1)f(n - 1) + \sum\limits_{i = 2}^{n - 2} (n - i - 1) f(i) f(n - i) (n \geq 2)$

分治 NTT 即可。

关于分治 FFT「我卷我自己」形式：[点我，最后一条](https://www.luogu.com.cn/blog/command-block/ban-zai-xian-juan-ji-xiao-ji)

[$Code$](https://loj.ac/s/1116329)

## $\mathcal{4.15}$

### 学习析合树

### $XJOI1730$

#### $T1$

好嘛，我卡在条件概率上了。但我们是 OIer 不是 MOer！！容斥就好啦……

具体来说，我们统计 $dep_u + dep_v - 2 * dep_{lca}$，利用期望线性性。真正麻烦的是算出以 $u$ 为 LCA 的对 $(x, y)$ 的个数期望。容斥，就只要算同时以 $u$ 为祖先的这样的 $(x, y)$ 对数期望了！！

做法好处在于，全是独立概率。

#### $T2$

很妙！原题 [Gym-102759L](https://codeforces.com/gym/102759/problem/L)

粘到「XXI Korea」去了。

#### $T3$

题出的好！难度适中，覆盖知识点广，题目又着切合实际的背景，解法比较自然。给出题人点赞！

挺有意思的 SAM 变异题。

鸽了，晚上一定（

### 省选联考 2021 订正

写在「」。
    
虽然被打击到了 :(，但是放弃自我就不是 xml 了！

## $\mathcal{4.16}$

### UR 14

单写

### [$UOJ77$](https://uoj.ac/problem/77)

（vfk：我自认为自己出过的最优美的题）

我为啥要向网络流找罪受，自己跟自己过不去 ~~这完全没有逻辑啊靠靠~~

二选一，只能是二分图，黑色连源点，白色连汇点。每个位置 $i$ 新建一个虚点 $i + n$ 表示「变成奇怪的方格」，连边 $(i, i + n, p_i)$。每个 $i + n$ 向前缀中某个权值区间的所有点的正常模式 $j$ 连边。

这么连边最重要的一个意思是，如果 $i$ 黑 $j$ 白就要割掉 $p_i$。如果 $p_i$ 没有被割，「$i$ 黑」和「$j$ 白」只能非此即彼了；如果 $p_i$ 被割了，$i$ 和代表黑的源点连，$j$ 和代表白的汇点连，刚好。

网络流找了一种最小化负面代价的安排方案。这是本质（

可持久化权值线段树优化建图，点边都是 $O(nlogn)$ 级别。

好妙啊，我在结尾认同了 vfk。（

[$Code$](https://uoj.ac/submission/469806)

## $\mathcal{4.17}$

### JOI 做了 4 道

## $\mathcal{4.18}$

上午 THU 来画饼= =。我清楚竞赛的结局可能不是甜的，但我的未来光明——这点毋庸置疑。

### [长乐-生成树求和](https://loj.ac/p/6271)

每位独立做。

生成函数卷积显然不行。考虑求出点值最后 idft。

考虑到这是个循环卷积，最后是个 $3$ 次多项式，只要带 $3$ 个点值。

带啥呢？单位根！要写扩域，除法自己推。

什么你看不懂 idft？就是手动乘逆矩阵了！注意因为你是 idft 回来，最后要除 $3$。

[$Code$](https://loj.ac/s/1119892)

## $\mathcal{4.19}$

### 300iq contest 1

写了两天，还差一道带花树，我当然是，义不容辞的咕咕咕了！！

## $\mathcal{4.20}$

### 订正了 XJOI1721 T3 大分块……

吐了呀……

### UNR #1

单写

## $\mathcal{4.21}$

### $XJOI1734$

IOI 赛制，好！

### $T1$

思路一直往沟里拐……= = 好在搞出来了。容易想到阶乘进制，容易想到取一个点做垃圾桶（就是其他点无用的边指向它然后它自己转），那么令 $1$ ~ $n - 1$ 分别往自己后面那位指一条边，然后往 $n$ 指「对应的阶乘系数」条边，即可。由于第 $i$ 个的系数 $\leq n - i$，边不会不够用。

### $T2$

$[i | j^2]$ 意味着每个质因子 $p$，$e_i(p) * 2 \geq e_j(p)$（$e$ 是指数）。

$\sum\limits_{i = 1}^n \sum\limits_{j = i}^n [i \mid 2j^2] = \sum\limits_{i = 1}^n \sum\limits_{j = i}^n [g(i) \mid j] = \sum\limits_{i = 1}^n \lfloor \frac{n}{g(i)} \rfloor - \lfloor \frac{i - 1}{g(i)} \rfloor$

其中 $i = \prod p^{e(p)}$, $g(i) = 2^{\max(0, e(2) - 1)} \prod\limits_{p > 2} \lceil \frac{e(p)}{2} \rceil$

第二部分 $\sum\limits_{i = 1}^n \lfloor \frac{i - 1}{g(i)} \rfloor = \sum\limits_{i = 1}^n \frac{i}{g(i)} - n$。两部分都是积性函数，前缀和都可以 Min_25 筛。（㗅！）

### $T3$

[题解](https://static.xjoi.net/attachment/101734/flea_solution.pdf) 神数学题…… 我完全不会整除…… 感觉 THUSCH 要跪……

### 积劳成疾

写在「UNR 2」

### 滚榜、图函数

没写这儿（好凶哦

## $\mathcal{4.22}$

### 智商锁

写在「UR 6」

### EC Final 2018

单写

### 回转寿司

写在「JOI」

## $\mathcal{4.23}$

### [氪金手游](https://loj.ac/p/3124)

简单计数？只要你会容斥（

最后那句话是全集都被覆盖到的意思。$T$ 是第一次被取到的时间。

树的结构。考虑外向树，每个节点都比子树中所有位置早取，$x$ 处的概率为 $\frac{W_x}{S} \sum\limits_{i \geq 0} (\frac{S - s_x}{S})^i = \frac{W_x}{S_x}$，$f_{x, i}$ 表示 $x$ 子树 $\sum w = i$ 的合法概率，背包即可。

如果不是外向树呢？容斥！钦定不满足的反向边，剩余反向边忽略，反向「选中的反向边」，就转化成了外向树。
不用新开一维记录反向边奇偶性 = =，容斥系数乘在答案里就好。

[$Code$](https://loj.ac/s/1124041)

### XJOI1735

#### T1

考虑每个位置 $x$ 对哪些区间有贡献，设其到前一个同色位置的距离为 $len$，贡献的区间就是 $[1, n - x + 1], \cdots, [len, len + n - x + 1]$，差分，BIT 维护区间和即可（SGT 被卡了

#### T2

结论简单但是不太懂。

#### T3

班里的分块巨魔 根号 log 艹过去了 /se

---

最近在准备 THUSCH，特别想去游玩的说qwq！感谢 XJ 给了我这个本该退役的 caiji 机会 QAQ…… THUSCH 的题没有什么主题和方向，大模拟题大毒瘤题生僻算法都有可能出，所以还是以 vp ACM 场、JOISC 为主要做题方向，至于真题，少，没有代表性，浅尝辄止即可。

---

## $\mathcal{4.25}$

### 这两天做了 杭电19多校R6

### 学了拟阵！

### $JOI-$糖

## $\mathcal{4.26}$

### $THUSCH 2017$ 差一道宇宙广播

### [$CF355F$](https://www.luogu.com.cn/problem/CF335F)

题目转化为免费价值和尽可能大。先合并价值相同的馅饼，然后从大到小做。

$n^2$ dp，$f[i, j]$ 表示前 $i$ 个馅饼有 $j$ 个免费。那么还剩 $i - 2j$ 可配。两种决策：退一配二，配一。

正解是反悔贪心。已选免费馅饼的个数就是堆的 $size$。

当前价值为 $a$，$a$ 元馅饼先贪心和可配的配掉，丢进决策堆里。

但是剩了一些 $a$ 元馅饼，这些可以不免费，也可以替换前面匹配掉的免费的最便宜的馅饼（决策），从堆里取堆顶弹出，设为 $b$ 元，注意 $b$ 可能小于 $a$ 因为 $b$ 并不是纯馅饼，它是决策，决策受到后期调整。

- $a > b$：将 $b$ 弹出，将两个 $a$ 放进（剩一个则放一个）表示 $b$ 的名额给 $a$，$b$ 自己出来又能匹配一个 $a$
- $a < b$：可以不动 $b$，也可以买 $b$ 配两个 $a$。对应的决策为：
  1. 丢进堆一个 $b$ 表示补偿弹出事件，买了两个 $a$，提供了俩名额
  2. 丢进堆一个 $2a - b$，表示 $b$ 让出了又产生了俩名额，给 $a$ 用掉了
  
  两个决策都选，表示既不动 $b$ 又用了俩名额给 $a$。对应的，$tot - 2 * size$ 值增大 $2$，名额减少了 $2$！而只选一个决策，$tot - 2 * size$ 值增大 $1$（$tot$ 将变大），名额减少了 $1$，完美。

[$Code$](https://codeforces.com/problemset/submission/335/114245490)

### [$LOJ3399-Communication Network$](https://loj.ac/p/3399)

单写

### [$UR10-$世界线](https://uoj.ac/submission/472673)

又是你…… 信息论风格的题……

$n^2$ 太笨了，想要减少询问其实就是减少块数。

将 $1$ ~ $n$ 排列成**下三角**，第一轮将 $x$ 相同的看作一个块，第二轮将 $y$ 相同的看作一个块，利用**块大小**来分辨对应关系。

但是可能撑不满。

考虑在竖着分组的时候把最后一个块（假设完整的有 $k$ 行，第 $k + 1$ 行有 $rest$ 个元素）第 $rest$ 个元素拎到 $(k + 1, k + 1)$ 处，前面 $rest - 1$ 个从大到小分别归到 $len, len - 1, \cdots, len - rest + 2$ 的块里，这样只有装着第 $rest$ 个元素的块的 $size$ 为 $1$。再根据横向对应关系把这 $rest$ 个全部确定掉。

[$Code$](https://uoj.ac/submission/472673)

## $\mathcal{4.27}$

### $XJOI1739$

#### $T1$

我没有智商也不会打表 /悲。得，又是奇偶性。准确来说，答案与「奇数长度的砖块数量和」有关。没有砖时后手胜，此时奇偶性为偶。

1. 偶数为 $0$
  
    整个是个奇数游戏。
    
    不管先手怎么操作，后手都能使奇数长度砖块奇偶性不变，且偶数长度砖块个数不变。
    
    其 SG 值就是总数的奇偶性。
2. 奇数为 $0$

    是很多个独立的偶数游戏。其 SG 值有规律（见官方题解）

全部异或起来。

### $T2$

复读没意思，见题解。

### $T3$

算出「抽一个五星角色的期望次数 $t$」和「期望轮数 $e$」。$t = \sum\limits_{i = 1}^{mxc} p * (1 - p)^{i - 1}$，等比数列求和；$e_i = e_{i - 1} + n / (n - i)，e = n \sum\limits_{i = 1}^n \frac{1}{i}$。~~这好像没有数学解法……~~ hhz：你不行，分块拉插，根号 $log$。但是显然分段打表啊，取块长为 $1e7$ 级别。

### 数树

单写

### [旧试题](https://loj.ac/p/2565)

$ans = \sum\limits_x \sum\limits_y \sum\limits_z \mu(x) \mu(y) \mu(z) f(A, [x, z]) f(B, [x, y]) f(C, [y, z])$

其中 $f(A, d) = \sum\limits_{d | i}^A \frac{A}{i} = \sum\limits_{1 | i}^{A/d} \frac{A/d}{i} = f(A/d, 1)$

$ans = \sum\limits_x \sum\limits_y \sum\limits_z \mu(x) \mu(y) \mu(z) f(A / [x, z]) f(B / [x, y]) f(C / [y, z])$

合法的三元环 $(x, y, z)$ 对数很少，分析同普通的三元环计数（大度点 $\sqrt{m}$ 个，小度点度为 $\sqrt{m}$，$O(m \sqrt{m})$）。枚举 $d = gcd(x, y, z)$，$x/d$, $y/d$, $z/d$，剪一大堆枝，就能水过去了？emmmm不想搞了，我想做 XXI！

### [$ROI-Innophone$](https://loj.ac/p/2845)

从小到大枚举 $a = x_i$，维护 $y$ 的递减序列，$b = y_i$ 的贡献为 $i * y_i$，还要支持后缀加、全局最大值。线段树、平衡树都可以做？

考虑分块。tag 不能在查询的时候下传，假设我们在查第 $x$ 块的最大值，其实就要查 $\max\limits_{i \in Set(x)}(y_i * tag_x + f[i])$

$y_i * -tag + mx = f_i$，维护上凸包

不考虑下传，$-tag_x$ 递减，满足单调性，单调队列维护一下。

第一次写这玩意儿，也就是常规操作。

[$Code$](https://loj.ac/s/1126772)

### XXI GP Korea

分块凸包给我写的神志模糊，打开 Gym 立马神清气爽。

单写。

### [元旦老人与丛林](https://uoj.ac/problem/168)

我放弃拟阵了。膜题解去。

如果 $E > 2(V - 1)$，输出 No。否则有结论：若每个非空子图都满足 $E \leq 2(V - 1)$，就是丛林。

来复读证明。归纳。

令当前图最小节点为 $u$，$u$ 的度只能为 $0$、$1$、$2$、$3$

度为 $0$、$1$、$2$ 的时候 $u$ 对原图是否是丛林没有影响。只考虑度为 $3$ 的情况。

引理 1. 两个满子图（$E = 2V - 2$）的并，仍是满子图

设和 $u$ 相连的三个点为 $a$、$b$、$c$，设 $G$ 去掉 $u$ 和与 $u$ 相连的三条边后结果为 $G1$

引理 2. $a$、$b$、$c$ 中至少存在一对节点 $(x, y)$ 使得 $G1$ 中不存在同时包含 $x$ 和 $y$ 的满子图

考虑反证，假设存在分别包含三个对的满子图，由引理 1 我们把这三个满子图并起来就得到了 $G1$ 的一个同时包含 $(a, b, c)$ 的满子图，我们把删掉的 $u$ 和三条边加入就得到了一个 $E = 2V - 1$ 的子图，矛盾。

于是我们可以加入边 $(x, y)$ 得到 $G2$，满足 $G2$ 也是丛林，将 $G2$ 拆分成两棵森林，删掉 $(x, y)$ 并连上 $(u, x)$, $(u, y)$ 和最后剩下的那条边，就得到了 $G$ 拆分成的两棵森林，因此 $G$ 是丛林。

神仙！！！！！玄学。

问题转化为是否存在一个非空子图，$E > 2(V - 1)$

这个可以最大权闭合子图做！（神仙owo）为每条边建点，对于第 $i$ 条边 $(u_i, v_i)$，连边 $(i + n, u_i)$, $(i + n, v_i)$，边点权值 $1$，点点权值 $-2$。

设最小割为 $c$，我们要判断是否 $m - c > -2$，但是 $c \geq 0$，所以要枚举强制选点，即断掉对应的边表示强制选，跑 $n$ 次网络流。

dinic $O(nm \sqrt{n})$

每次断边重新跑，太费了，考虑退流，玄学优化。

[$Code$](https://uoj.ac/submission/473031)

---

脚扭伤了，好伤心。

逗 cmz 真好玩。说他听不懂的古文。我：竖子。cmz：竖子是啥？被骂了都不知道，菜哦。

开心了。（（

---

### 300iq contest 2

单写

## $\mathcal{4.30}$

生日还有 11 天！！

### [$AGC038E$](https://www.luogu.com.cn/problem/AT5202)

通用测评号加强版？

考虑生成函数做法。

$Pr[x \leq n] = n! [x^n] \prod\limits_{i = 0}^{n - 1} \sum\limits_{j \geq b_i} \frac{(\frac{a_i}{S})^j}{j!} x^j$

$= n! [x^n] \prod\limits_{i = 0}^{n - 1} ( e^{\frac{a_i}{S}}x - \sum\limits_{j = 0}^{b_i - 1} \frac{(\frac{a_i}{S})^j}{j!} x^j )$

$= n! [x^n] \sum\limits_{i = 0}^{S} coef_i(x) e^{\frac{i}{S} x}$

$ans = \sum\limits_{n \geq 0} Pr[x > n] = \sum\limits_{n \geq 0} - n! [x^n] \sum\limits_{i = 0}^{S - 1} coef_i(x) e^{\frac{i}{S} x}$

$= - \sum\limits_{n \geq 0} n! \sum\limits_{i = 0}^{S - 1} \sum\limits_{j = 0}^{\sum B} [x^j] coef_i(x) \frac{i^{n - j}}{S^{n - j} (n - j)!}$

$= - \sum\limits_{i = 0}^{S - 1} \sum\limits_{j = 0}^{\sum B} [x^j] coef_i(x) (\frac{S}{i})^j \sum\limits_{n \geq 0} (\frac{i}{S})^n \frac{n!}{(n - j)!}$

考虑后面那个无穷级数怎么搞，它长得很像组合数，$j! (\frac{i}{S})^n \binom{n}{j}$。设 $F_j(x) = \sum\limits_{i \geq 0} \binom{i}{j} x^i$，有组合数的就可以考虑裂项了，后面的就是 $j! F_j(\frac{i}{S})$。那么有 $F_j(x) = x F_{j}(x) + x F_{j - 1}(x)$，那么有递推式 $F_j(x) = \frac{x}{1 - x} F_{j - 1}(x)$。$F_0(x) = \frac{1}{1 - x}$

[$Code$](https://atcoder.jp/contests/agc038/submissions/22164402)

### [$51nod2589-$快速讨伐](http://www.51nod.com/Challenge/Problem.html#problemId=2589)

装备和敌人都可以不按顺序来。但是倒着的话就可以预定位置。

$dp[i, j]$ 表示还有 $i$ 步角色和 $j$ 步装备没有填

转移：
- $dp[i, j] \rightarrow dp[i - 1, j]$
- $dp[i, j] * \binom{ n - i + n - j + sum[n] - sum[j - 1] }{ a_j } a_j! \rightarrow dp[i, j - 1]$

### [$51nod2591-$最终讨伐](http://www.51nod.com/Challenge/Problem.html#problemId=2591)

这个题意看的我一脸懵圈。每人都有「是否得病」和「是否有石头」的初始状态。每人依次选一个人发动石头。选择的人得有病，且不能有石头或已经被发动过了。顺序有关。

设「只得病」为 $a$，「只有石头」为 $b$，「都有」为 $c$

三种转移：
1. $c \rightarrow a$
2. $b \rightarrow a$
3. $c$ 组成置换圈（多个环的那种）

$dp[i, j]$ 表示还剩 $i$ 对一样有另一样没有的，$j$ 对俩都有的。

- $dp[i, j] * i * j \rightarrow dp[i, j - 1]$ $(1)$
- $dp[i, j] * i * i \rightarrow dp[i - 1, j]$ $(2)$
- $\sum\limits_{k = 0}^{m} dp[0, k] * \binom{n + m}{k} (k!)^2$ $(3)$

### [$51nod2590-$持续讨伐](https://www.51nod.com/Challenge/Problem.html#problemId=2590)

K 这么小肯定是矩乘啦！分段矩乘！

$dp[i, j]$ 表示到 $i$，$i$ 所在的为 $j$ 次方，与前面所有 $k$ 次方段贡献的乘积和，转移就乘个组合数

我吐了，怎么卡都卡不进去，把取模加改成二目运算就啥都艹的过去。

### [$51nod1407-$与与与与](https://www.51nod.com/Challenge/Problem.html#problemId=1407)

什么你想莽上？醒醒~

二项式反演，设 $f(x) = \sum\limits_{i = 0}^{n - 1} [a_i \& x == x]$，
$ans = \sum\limits_{s} (-1)^{|s|} 2^{f(x)}$

$f$ 可以 FWT 与卷积卷出来
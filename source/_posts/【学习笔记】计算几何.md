---
title: 【学习笔记】计算几何
date: 2021-08-07 12:25:40
tags: 
    - 学习笔记
mathjax: true
---

## 常用向量运算

- 长度 $abs$
- 范数 $norm$（模长平方）较小数开根损精度而且慢
- 极角 $atan2$
- 归一化（转化为单位向量）
- 标量乘除（乘一个数字）
- 加减
- 点积 $dot$
- 叉积 $det$（因为其行列式意义）
- 复数积（旋转, $*(cos + sin * i)$, $(x, y) \rightarrow (x * cos \alpha - y * sin \alpha, x * sin \alpha + y * cos \alpha)$）
  - 特殊：旋转 $90$ 度，最好单独编写函数 $(x, y) \rightarrow (-x, y)$

## zrf 大佬的程序设计建议

- OOP（面向对象编程，对象：逻辑上有联系的数据，逻辑上是整体，便于调试）：其实就是 struct 化？
- FP：将逻辑上的纯函数实现为纯函数（纯函数：不访问全局变量，返回值只与参数有关，不改传进的参数，便于调试）
- 功能细分：即使只有一次调用也划分为单独函数，长函数名当作注释
- 尽量使用整数运算

## 浮点误差

计算机函数的计算无误差，而是存储有误差，会造成 $10^{-15}$ 的误差，对于 sqrt 等函数是致命的

判 $nan$：$nan != nan$

$eps$ 的正确性：为什么实际差 $eps$ 以内的数不会出错？理论分布曲线在 $0$ 左右突变的极陡。*满足这个分布的才能用 $eps$*

在 $0$ 附近扰动会爆炸 $\rightarrow$ 认为他是 $0$

$eps$ 不要滥用，避免在二分中使用 $eps$, instead 直接二分某个常数次。为什么？

二分中使用 $eps$ 会加到答案上去。不写 $eps$ 时的误差仅是 $chk()$ 误差。
- $eps < chk()$ 误差：$while (r - l > eps)$ 无限循环
- $eps > chk()$ 误差：不划算

zrf 大佬发明的：求两个多维空间向量夹角：夹角较小就 $cos$ 算，较大就 $sin$ 算

## 常用运算和表示

- 点：一个向量 $u$
- 直线：一个起点向量 $u$，一个方向向量 $v$；或者两个端点向量
- 角：$(u, v_1, v_2)$
- 圆：圆心 $o$、半径 $r$

- 点和直线位置关系
- 点和圆的位置关系
- 两条线段是否相交（快速排斥实验 + 跨立实验）
- 过定点，直线的垂线、平行线（熟练运用向量旋转）
- 点到直线距离（叉积）
- 点到直线的垂足（点积）
- 垂直平分线
- 角平分线（注意特判共线）
- 两直线的交点
  1. 面积法（任取点）
  2. 代数法（$p = a_1 + c_1 v_1 = a_2 + c_2 v_2$，写成矩阵形式，克莱姆法则）
- 圆和直线交点（注意开根，开根速度可视为 $log$；讨论 $0/1/2$ 个交点）
- 两圆交点（解三角形的圆心角）
- 公切线（放缩 + 平移）

遇事不决，解三角形！勾股yyds。

### 极角排序！

不写 atan2 快 1000 ms！

``` c++
int Qua(Vec a) {  // quadrant 象限
  if (a.x > 0 && a.y >= 0) return 1;
  if (a.x <= 0 && a.y > 0) return 2;
  if (a.x < 0 && a.y <= 0) return 3;
  if (a.x >= 0 && a.y < 0) return 4;
  return 0;
}
bool cmp(Vec a, Vec b) {
  if (Qua(a) == Qua(b)) {
    db t = det(a, b);
    if (!sgn(t)) return a.x < b.x;
    return sgn(t) > 0;
  } return Qua(a) < Qua(b);
}
```

### [清训-定向越野](https://uoj.ac/problem/277)

路径一定是若干段公切线和若干段圆弧。

求出每对圆的四条公切线。公切线求出来还要判是否穿过其他圆，所以是 $O(n^3)$

把切点拿出来跑最短路，同个圆相邻两个切点间连边，共是 $O(n^2)$ 个点和 $O(n^2)$ 条边。

细节：

1. 如何求公切线：设大圆半径为 $r_1$, 小圆半径为 $r_2$，从小圆圆心向大圆半径为 $r_1 \pm r_2$ 的圆求切线，分别两条，然后平移回去。

2. 圆上距离怎么算：半径为 $r$ 的圆上 $A$、$B$ 两点距离为 $d$，圆心角 $= 2 arcsin(\frac{d}{2r})$，或者用 $atan2$ 函数算，减去或者加上 $PI$

3. 如何判线段与圆有两个交点：等价于圆心到线段的距离小于圆半径

坑点：$eps$ 要开 $1e-15$

xml 的丝柏行为：依旧快读读入…… 竟然拿到了 $97$ 的高分 smg？

[$Code$](https://uoj.ac/submission/502617)

## 一些 trick 杂录

- 计算几何最优化，要在连续空间中选择，不能枚举的问题：二分、三分；利用所有的性质将「无限解」缩到「可枚举的有限解」，比如做 $n$ 只有 $100$ 的 $O(n^3)$ 最小圆覆盖
- "自由度" 的刻画功能，可以帮助理解一些问题为什么可以用这样的复杂度解决。但只能刻画连续，离散模型的自由度是 0。
- atan2 是从 $-180$/$180$ 开始。排序需预处理加速因为真的非常慢！推荐判象限 + 全整数叉积。
- 判点是否在多边形内部：
    1. 转角法（端点间角度和为 $2\pi$）
    2. 射线法（边经过奇偶次）
- 求多边形面积
    1. 三角剖分
    2. 格林公式：向 x 轴做垂线（我不太懂啦
- 平面最近点对
    1. 做法一：kd-tree
    2. 做法二：随机 rand 一个角度转所有点

    ``` c++
    for i 1 -> n
      for j 1 -> n
        if (p_i - p_j).x > ans
          break;
    ```
      
    或者转坐标轴，按投影排序

## 凸包相关

就，变着法儿切它呗

### 动态凸包

set 维护上下凸壳，插入就 ban 它两边的点

### 旋转卡壳

特殊的极角扫描，不用排序所以不是 log 而是线性的，按「事件触发」那套理论，事件发生在切一条边的时候，按事件归并

注意「最近点对」问题：可能是点到线段垂线

### 凸包公切线

求上公切线：两条斜率相同的线卡着转，重合时为所求

实现时找「距离函数」过 0 点的位置

### 半平面交

因为要首尾相接，维护双端队列

但实际上转凸包更好对吧

### 例题：ASC 40 Average Convex Hull

#### 做法一

分治，递归到 $[l, r]$ 时保证 $[1, l - 1]$ 和 $[r + 1, n]$ 所有点都在凸包里

#### 做法二

求两层凸包，删的时候更新剥掉的三角形内的内层贡献；对每个内层凸包点求出所在三角形位置。

#### 做法三

更好写的方法！

剥掉点 $A$ 时（所在三角形另两个顶点分别为 $B$ 和 $C$）$B$ 和 $C$ 向下做垂线，垂线范围内重建，均摊下来每个点重建两次

## 积分

$\int_a^b f(x) dx$，$f(x)$ 是数值，$dx$ 是横轴上这段极短的长度

## 一元积分

### 求函数下方面积

格林公式：

$$
\int \int_D ( \frac{\partial Q}{\partial x} - \frac{\partial P}{\partial y} ) dxdy = \oint_{L} Pdx + Qdy
$$

其中 $D$ 为分段光滑的曲线 $L$ 围成的闭区域。$\partial$ 是偏导符号。$\oint$ 是曲线积分符号。

### 求一般图像面积

原则：上边界减下边界。所以步骤一般都是 1. 找边界 2. 积分（用柱状体拟合，方便且误差小，靠近曲线部分的面积比下面部分为 $dx$ 级别的）

#### BZOJ2178 圆的面积并

1. 求边界

    圆两两求交点，同圆上的交点排序，扣掉！
2. 求面积

    分为弓形和梯形。
    
    弓形：每条边界是上还是下，不重要！因为符号带方向：
    - 上边界：向左，$\int y (-dx)$
    - 下边界：向右，$-\int y dx$
    
      都是 $-\int y dx$!

    梯形：向左：$+$ 向右：$-$

能做到 $10^{-9}$。

积分相关：格林公式的应用。

我们要求

$$
\int \int_D 1 dxdy
$$

设格林公式中的 $P = -y$, $Q = x$，有

$$
\int \int_D 1 dxdy = \frac{1}{2} \oint_L xdy - ydx
$$

考虑对于一段圆弧，如何求 $\int xdy - ydx$（已知圆心 $(x_0, y_0)$，圆弧角度 $\theta \in [\alpha, \beta]$）

显然 $x = x_0 + r \cos \theta, y = y_0 + r \sin \theta$。

$$
\int xdy - ydx \\
= \int_{\alpha}^{\beta} (x_0 + r \cos \theta) d \theta \frac{dy}{d \theta} - ( y_0 + r \sin \theta ) d\theta \frac{dx}{d \theta} \\
= \int_{\alpha}^{\beta} (x_0 + r \cos \theta) d\theta \cos \theta + (y_0 + r \sin \theta) d \theta \sin \theta
$$

三角函数积分公式：

$$
\int \cos \theta d \theta = \sin \theta + C \\
\int_0^x \cos^2 \theta d \theta = \frac{x}{2} + \frac{\sin 2x}{4} + C \\
\int_0^x \sin^2 \theta d \theta = \frac{x}{2} - \frac{\sin 2x}{4} + C
$$

### 拓展：圆环面积并

考虑解决严格强的问题：若干圆 $G_i$ 的交并补面积

补可以转化为交并。考虑建立表达式树，即「叶子是值，非叶子是操作类型」的树。

1. 求边界。求边界在 $G_i$ 部分。

    $n^2$ 个交点，表达式树帮助 check 是 $O(n)$ 的。具体来说是取内外挨得很近的 $P1$ 和 $P2$ 必须一个在最终面积里，一个不在。$O(n^3)$。
2. 积分

### airport construction (WF2017)

最优解一定卡在两个点上。否则微扰，一定有一个方向更优。

枚举点，加上射线形成一条直线，然后判三点共线就判相邻两个点是否在直线同侧。

### 曲线长度

$$\int \sqrt{(x'(t) dt)^2 + (y'(t) dt)^2} = \int dt \sqrt{(x')^2 + (y')^2}$$

这就不能用柱状体拟合了啊，将近 $\sqrt{2}$ 倍的误差…… 所以就只能折线 + 勾股

### 旋转体

体积：柱状体拟合，$\int \pi f^2(x) dx$

表面积：折线拟合，圆台公式

## $simpson$ 积分公式

“是一个没有时间证明和正确性证明的经验性算法”

用二次函数进行插值，拟合。任取三个点 $a < b < c$, 公式是

$$I = \frac{1}{6} (f(a) + 4f(c) + f(b)) (b - a)$$

递归，

```
|------I1------|
|--I2--||--I3--|
a       c      b
```

$I1$ 约等于 $I2 + I3$ 时停止递归（注意 $eps$ 的设置！$eps$ 可以随着递归直接传下去，也有人说传下去的应当是 $eps/2$ ……

像刚才那道圆的面积并，提取所有有圆的横轴区间做自适应辛普森，不过精度比较差，只能做到 $10^{-3}$

### cherry orchard (BSUIR final 2015)

咕咕咕
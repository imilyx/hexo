---
title: '[NOI2011]-é˜¿ç‹¸çš„æ‰“å­—æœº'
date: 2019-08-08 23:10:40
tags: 
    - ACè‡ªåŠ¨æœº
    - dfsåº
mathjax: true 
---

[ä¼ é€é—¨](https://www.lydsy.com/JudgeOnline/problem.php?id=2434)

åšè¿™é¢˜ä¹‹å‰ï¼Œå¯ä»¥å…ˆå»æ ä¸€æ  [æ­¤é¢˜](https://www.luogu.org/problem/P3966) äº†è§£ä¸€ä¸‹ Fail æ ‘ã€‚æœ¬é¢˜æ˜¯å¾ˆç›¸ä¼¼æ»´ï¼

æˆ‘ä»¬å‘ç°ï¼Œå¦‚æœæ¯æ¬¡æ­£å„¿å…«ç»åœ¨ Trie æ ‘ä¸Šèµ°ä¸€é y ä¸²ï¼Œé‚£æ˜¾ç„¶ä¼š TLEã€‚T å°± T åœ¨æ¯æ¬¡é‡å¤ç»è¿‡çš„è·¯çº¿ã€‚

è¿™å¯å‘æˆ‘ä»¬è®¾è®¡ç¦»çº¿ç®—æ³•ï¼Œéå†æ•´æ£µ Trie æ ‘ï¼Œæ ‡è®°èµ°è¿‡çš„è·¯çº¿ä¸º 1ï¼›æ¯ç¢°åˆ°ä¸€ä¸ªç»“æŸç‚¹ï¼Œéƒ½å›ç­”ä»¥è¯¥ç‚¹ä¸º y ä¸²ç»“æŸç‚¹çš„è¯¢é—®ã€‚

å›ç­”è¯¢é—®ä¹Ÿä¸éš¾ï¼Œæ ¹æ® TJOI2013-å•è¯ å¾—æ¥çš„ç»éªŒå€¼ï¼Œæ±‚ x åœ¨ y ä¸­å‡ºç°çš„æ¬¡æ•°å°±æ˜¯æ±‚å½“å‰ x å­æ ‘ä¸­ä¸º 1 çš„ç»“ç‚¹æ•°ã€‚è·Ÿå­æ ‘ç›¸å…³çš„ problem è¯·å‡ºé—¨å·¦è½¬ dfs åºï¼è°¢è°¢ï¼ï¼ï¼ˆç”¨æ ‘çŠ¶æ•°ç»„ç»´æŠ¤å°±ğŸ‰‘ï¸

è¯´è¯´å®¹æ˜“å†™å†™éš¾å•Š QwQ 109è¡Œä»£ç å¯è¿˜ğŸŒŸ

code :
#include <bits/stdc++.h>
#define rep(i, x, y) for (int i = x; i <= y; i++)
#define lowbit(x) ((x) & (-(x)))
using namespace std;

const int N = 1e5 + 10;
int Q, n, tot, len, dfn, sz;
int fa[N], fail[N], idx[N], ch[N][26], mark[N];
int to[N << 1], nxt[N << 1], lnk[N], ecnt;
int in[N], out[N];
int ql[N], qr[N], ans[N], C[N];
char s[N], t[N], tt[N << 1];
struct ques { int x, y, id; }que[N];
bool operator < (ques a, ques b) { return a.y < b.y; }

void addedge(int x, int y) {
	to[++ecnt]= y, nxt[ecnt] = lnk[x], lnk[x] = ecnt;
}

int ord(char c) { return c - 'a'; }

void build(char *s) {
	int u = 0;
	rep(i, 1, n) {
		if (s[i] == 'P') {
			idx[++tot] = u, mark[u] = tot;
		} else if (s[i] == 'B') {
			u = fa[u];
		} else {
			int c = ord(s[i]);
			if (!ch[u][c]) ch[u][c] = ++sz;
			fa[ch[u][c]] = u;
			u = ch[u][c];
		}
	}
}

void getfail() {
	queue<int> q;
	rep(c, 0, 25) {
		int u = ch[0][c];
		if (!u) continue;
		fail[u] = 0;
		q.push(u);
		addedge(0, u);
	}
	while (q.size()) {
		int u = q.front(); q.pop();
		rep(c, 0, 25) {
			int v = ch[u][c];
			if (!v) continue;
			q.push(v);
			int k = fail[u];
			while (k && !ch[k][c]) k = fail[k];
			fail[v] = ch[k][c];
			addedge(fail[v], v);
		}
	}
}

void dfs(int x) {
	in[x] = ++dfn;
	for (int i = lnk[x]; i; i = nxt[i]) dfs(to[i]);
	out[x] = dfn;
}

void add(int x, int val) {
	if (!x) return;
	for (; x <= dfn; x += lowbit(x)) C[x] += val;
}

int query(int x) {
	int ret = 0;
	for (; x; x -= lowbit(x)) ret += C[x];
	return ret;
}

void solve(int x) {
	if (x) add(in[x], 1);
	if (mark[x])
		rep(i, ql[mark[x]], qr[mark[x]])
			ans[que[i].id] = query(out[idx[que[i].x]]) - query(in[idx[que[i].x]] - 1);
	rep(c, 0, 25) if (ch[x][c]) solve(ch[x][c]);
	if (x) add(in[x], -1);
}

int main() {
	// freopen("in.txt", "r", stdin);
	scanf("%s", s + 1);
	n = strlen(s + 1);
	build(s);
	getfail();
	dfs(0);
	
	scanf("%d", &Q);
	rep(i, 1, Q)
		scanf("%d%d", &que[i].x, &que[i].y), que[i].id = i;
	sort(que + 1, que + Q + 1);
	for (int i = 1, pos = 1; i <= Q; i = pos) {
		ql[que[i].y] = i;
		while (que[i].y == que[pos].y) ++pos;
		qr[que[i].y] = pos - 1;
	}
	solve(0);
	rep(i, 1, Q) printf("%d\n", ans[i]);
	return 0;
}
```
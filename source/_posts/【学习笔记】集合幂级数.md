---
title: 【学习笔记】集合幂级数
date: 2020-08-07 20:05:40
tags: 
    - 学习笔记
    - 集合幂级数
mathjax: true
---

```
打开了新世界的大门。
```

抽个时间补一下 ~ 不写点什么这玩意很快就在大脑里就变成黑箱子了。

## FMT
---

用来计算集合幂级数乘法。还有一种分治乘法，本质相同。

FMT: $\hat{f_S} = \sum\limits_{T \subseteq S} f_T$

FMI：$f_S = \sum\limits_{T \subseteq S} (-1)^{|S| - |T|} \hat{f_T}$

（子集反演就是 FMT 和 FMI）

一个集合幂级数有逆元当且仅当 FMT 后所有系数均不为 $0$。

类似 FFT 带 $n$ 次单位根，我们可以看作往里带了一堆特征向量最后插值插了回来。但是由于博主过菜，论文这部分没看太懂。。

## FWT
---

有结论：对于一个集合 $S$ 有 $\frac{1}{2^n} \sum\limits_{T \subseteq 2^U}(-1)^{|S\cap T|} = [S = \emptyset]$，证明考虑 $S$ 不为空时从 $S$ 里拎走一个数后 $-1$ 的正负性改变，与拎走前的抵消。

那么对于异或卷积 $h_S = \sum\limits_{L \subseteq 2^U} \sum\limits_{R \subseteq 2^U} [L \oplus R = S] f_Lg_R$ 就有新的思路：

$$h_S = \sum\limits_{L \subseteq 2^U} \sum\limits_{R \subseteq 2^U} [L \oplus R \oplus S = \emptyset] f_Lg_R$$

$$= \sum\limits_{L \subseteq 2^U} \sum\limits_{R \subseteq 2^U} \frac{1}{2^n} \sum\limits_{T \subseteq 2^U} (-1)^{|T \cap (L \oplus R \oplus S)|} f_Lg_R$$

$$= \sum\limits_{L \subseteq 2^U} \sum\limits_{R \subseteq 2^U} \frac{1}{2^n} \sum\limits_{T \subseteq 2^U} (-1)^{|T \cap L|} (-1)^{|T \cap R|} (-1)^{|T \cap S|} f_Lg_R$$

$$= \frac{1}{2^n} \sum\limits_{T \subseteq 2^U} (-1)^{|T \cap S|} ( \sum\limits_{L \subseteq 2^U} (-1)^{|T \cap L|} f_L ) ( \sum\limits_{R \subseteq 2^U} (-1)^{|T \cap R|} g_R )$$

于是定义 FWT：$\hat{f_S} = \sum\limits_{T \subseteq 2^U} (-1)^{|T \cap S|} f_T$

IFWT：$\hat{f_S} = \frac{1}{2^n} \sum\limits_{T \subseteq 2^U} (-1)^{|T \cap S|} f_T$

``` c++
void FWT_xor(ll a[], int op = 1) {
    rep(i, 1, n)
        rep(j, 0, (1 << n) - 1)
            if (!((j >> (i - 1)) & 1)) {
                ll x = a[j], y = a[j + (1 << (i - 1))];
                a[j] = (x + y) % mod, a[j + (1 << (i - 1))] = (x - y + mod) % mod;
                if (op == -1) (a[j] *= inv2) %= mod, (a[j + (1 << (i - 1))] *= inv2) %= mod;
            }
}
```

## Or 和 And 卷积
---

以 Or 为例：

$$h_S = \sum\limits_{L \subseteq 2^U} \sum\limits_{R \subseteq 2^U} [L \cup R = S] f_Lg_R$$

对两边同时做 FMT

$$\hat{h_S} = \sum\limits_{L \subseteq 2^U} \sum\limits_{R \subseteq 2^U} [L \cup R \subseteq S] f_Lg_R$$

$$= \sum\limits_{L \subseteq 2^U} \sum\limits_{R \subseteq 2^U} [L \subseteq S][R \subseteq S] f_Lg_R$$

**Or 卷积本质是高维前缀和。** 

And 卷积取反后做 Or 卷积再取反也是可行的 qwq。当然也有朴素的分治乘法。

``` c++
void FWT_or(ll a[], int op = 1) {
    for (int k = 1; k < (1 << n); k <<= 1)
        for (int i = 0; i < (1 << n); i += (k << 1))
            for (int j = 0; j < k; ++j)
                a[i + j + k] = (a[i + j + k] + a[i + j] * op + mod) % mod;
}
void FWT_and(ll a[], int op = 1) {
    for (int k = 1; k < (1 << n); k <<= 1)
        for (int i = 0; i < (1 << n); i += (k << 1))
            for (int j = 0; j < k; ++j)
                a[i + j] = (a[i + j] + a[i + j + k] * op + mod) % mod;
}
// FMT(= FWT_and)
void FMT(int op = 1) {
    rep(i, 1, n)
        rep(j, 0, (1 << n) - 1)
            if ((j >> (i - 1)) & 1)
                f[j] = (f[j] + f[j - (1 << (i - 1))] * op + mod) % mod;
}
```

## 子集卷积
---

$$\hat{h_S} = \sum\limits_{L \subseteq 2^U} \sum\limits_{R \subseteq 2^U} [L \cup R = S] [L \cap R = \emptyset] f_Lg_R$$

直接枚举子集 $3^n$。

$[L \cup R = S] [L \cap R = \emptyset] = [L \oplus R = S][|L| + |R| = |S|]$，记录一个占位数量，分层卷。应该满足 $1$ 的个数恰好为两者之和，**否则清空**。$O(n^22^n)$

## 拓展（$K$ 进制异或卷积）
---

And, Or 卷积在 $K$ 进制下可以拓展为取 $\min$, $\max$，做高维前缀和。

$K$ 进制下的 Xor 其实是两个向量列对列的不进位取模加法，**是个高维 DFT**，即**在 $n$ 个维度上分别做大小为 $K$ 的循环卷积**，因此需要用到 $K$ 次单位根 $\omega_K$。

考虑 DFT 带单位根进去，实际上是乘了这么个矩阵（范德蒙德矩阵）：

$$
T_k =
\left[
\begin{matrix}
\omega_{k}^{0} & \omega_{k}^{0} & \omega_{k}^{0} & \cdots & \omega_{k}^{0} \\
\omega_{k}^{0} & \omega_{k}^1 & \omega_{k}^2 & \cdots & \omega_{k}^{k - 1} \\
\omega_{k}^{0} & \omega_{k}^2 & \omega_{k}^4 & \cdots & \omega_{k}^{2(k - 1)} \\
\cdots & \cdots & \cdots & \ddots & \cdots \\
\omega_{k}^{0} & \omega_{k}^{k - 1} & \omega_{k}^{2(k - 1)} & \cdots & \omega_{k}^{(k - 1)(k - 1)} \\
\end{matrix}
\right]
$$

而 IDFT 实际上是乘了 $T_k$ 的逆矩阵：

$$
T_k^{-1} = \frac{1}{k}
\left[
\begin{matrix}
\omega_{k}^{0} & \omega_{k}^{0} & \omega_{k}^{0} & \cdots & \omega_{k}^{0} \\
\omega_{k}^{0} & \omega_{k}^{-1} & \omega_{k}^{-2} & \cdots & \omega_{k}^{-(k - 1)} \\
\omega_{k}^{0} & \omega_{k}^{-2} & \omega_{k}^{-4} & \cdots & \omega_{k}^{-2(k - 1)} \\
\cdots & \cdots & \cdots & \ddots & \cdots \\
\omega_{k}^{0} & \omega_{k}^{-(k - 1)} & \omega_{k}^{-2(k - 1)} & \cdots & \omega_{k}^{-(k - 1)(k - 1)} \\
\end{matrix}
\right]
$$

依次枚举 $0$ ~ $n - 1$ 每维，将每维 DFT，再将点值对应相乘，最后 IDFT 回来（注意最后要除以 $K^n$，因为共有 $n$ 层，$T_k * T_k^{-1} = KE$，$E$ 为单位矩阵，每层都多乘了一个 $K$；也可以从 IFWT 原理理解）。正确性可以用递归的思想理解。

复杂度 $O(n * K^{n - 1} * K^2)$（理解为 O(能过) 即可）

普通的 FWT 就是个特例啦，$\omega_2$ 这里取 $-1$，它的矩阵是：

$$
T_2 =
\left[
\begin{matrix}
1 & 1 \\
1 & -1
\end{matrix}
\right]
$$

### [石家庄的工人阶级队伍比较坚强](https://uoj.ac/problem/272)

当然要化奇怪规则为一般。发现赢的相减为 $1$，取模意义下输的相减为 $2$，平局当然是 $0$ 了。记 $B_{x - y} = b_{u, v} = b_{cnt(x - y, 1), cnt(x - y, 2)}$。则 $f_{i, z} = \sum\limits_{x + y = z} f_{i - 1, x} B_{y}$，这里的加减法是三进制不进位加减法。

所以这就是个 $n$ 维，每维长度 $3$ 的 DFT / $3$ 进制 FWT 做点值快速幂。用上面构造矩阵的方法构造一个 $3 * 3$ 单位根矩阵。$3$ 的单位根是 $\omega = \frac{-1+\sqrt{3}i}{2}$，我们选择扩域，但是 $\sqrt{3}$ 精度会有问题，所以我们把复数表示成 $a + b\omega$ 的形式而不是 $a + bi$，IDFT 之后 $\omega$ 就没了。

根据 $\omega_3$ 的性质：$\omega^2 + \omega + 1 = 0$，可以推得乘法：$(a + b\omega)(c + d\omega) = (ac - bd) + (ad + bc - bd)\omega$

IDFT 要除以 $n = 3^m$，需要 $n$ 存在逆元，即模数 $p$ 不是 $3$ 的倍数。题目那个性质保证了这点：用反证法，设存在正整数 $k = p / 3$，那么有 $1 / k + 1 / k(k + 1) = 1 / k = 3 / p$，矛盾。

[$Code$](https://uoj.ac/submission/453533)
---
title: '【学习笔记】网络流'
date: 2021-02-14 13:11:40
tags:
    - 学习笔记
    - 网络流
encrypt: true
---

# 网络流

咱不聊 EK 哈，EK 莫得用处。

## Dinic

构建分层图，在分层图上增广。

### 一般图：$O(n * nm)$

每次构建分层图，残量网络上 $s$ 到 $t$ 的最短路严格递增，至多重建 $n - 1$ 次分层图。

至于 dfs 增广复杂度，构建一次分层图至多增广 $m$ 次，每条路径长度至多 $n$。

### 单位图：$O(\sqrt{n} * nm)$

每个**点**要么入度为 $1$ 且连进来的边容量为 $1$，要么出度为 $1$ 且连出去的边容量为 $1$。

定义流图 $f$ 的 $|f|$ 表示该图上的流的个数，即流形成的路径数。

设当前流的图为 $P$，目标最大流的图为 $Q$，$P$ 的残量网络是 $R$，那么 $Q - P$ 是 $R$ 上的一个流，有许多路径，可能还有环。**因为 $R$ 是单位图，除了 $s$ 和 $t$ 以外的每个点至多属于一条路径**，$dis(s, t) \leq \frac{n - 2}{|Q| - |P|} + 1$（每次增广最短路严格递增）

经过 $\sqrt{n - 2}$ 次增广后，$dis(s, t)$ $\geq \sqrt{n - 2} + 1$，即 $|Q| - |P| \leq \sqrt{n - 2}$，即至多再增广 $\sqrt{n - 2}$ 次就可以结束算法。

### 单位容量图：$O(\min(n^{2/3}, m^{1/2}) * nm)$

每条**边**容量为 $1$。

结论：这样的图设其最大流为 $M$，$dis(s, t) \leq \frac{2n}{\sqrt{M}}$。

证明：设最短路长度为 $l$，即分层图有 $l$ 层，设第 $i$ 层点集为 $V_i$, 则 $M \leq |V_i|\cdot|V_{i + 1}|$，所以 $V_i$ 和 $V_{i + 1}$ 必有一个 $\geq \sqrt{M}$，所以 $\frac{l + 1}{2} * \sqrt{M} \leq n$，即 $l \leq \frac{2n}{\sqrt{M}}$。

当前已有流 $F \leq M - n^{2/3}$ 时，残量网络最大流 $= n^{2/3}$，$l \leq 2n^{2/3}$；$F > M - n^{2/3}$ 时，残量网络最大流 $< n^{2/3}$，至多进行 $n^{2/3}$ 次增广。

至于 $m^{1/2}$，证明同「单位图」，只是**每条边至多属于一条路径**。

### Bonus: LCT 优化 Dinic 分层图上增广过程

LCT 可以很好的维护加边、寻找路径上最小值、路径减一个值和删边等操作，复杂度 $O(nmlogm)$ ~~然而赛场上没人写它~~

## 上下界网络流

### 无源汇有上下界可行流（即可行循环流）

令每条边的流量等于下界，得到一个初始流。考虑在残量网络上求出一个不满足流量平衡限制的附加流使得附加流和初始流合并后满足流量平衡。构造残量网络使得 $[l, r]$ 的边容量为 $r - l$。

若初始流中 $i$ 点流入比流出多 $x$，那在附加流中就要流出比流入多 $x$。少 $x$ 亦然。

建立虚源汇点 $s_0$, $t_0$。若在附加流中 $i$ 点需要流入比流出多 $x$，则连边 $(s_0, i, x)$，否则连边 $(i, t_0, -x)$。

### 有源汇有上下界可行流

连边 $(t, s, \infty)$。最后得到的有源汇流的流量即为 $(t, s, \infty)$ 的流量。

### 有源汇有上下界最大流

先求一个有源汇有上下界可行流，然后在残量网络上跑 $s-t$ 最大流。

### 有源汇有上下界最小流

利用反向边——先求有源汇有上下界可行流，再在残量网络上跑 $t-s$ 最大流。

# 费用流

分为最小费用流和最小费用最大流。

复杂度 $= |f| * (spfa ? nm; dij ? mlogm)$

## Primal-Dual 原始对偶算法

初始运行一遍 Bellman-Ford 求出初始 $s$ 到每个点最短路。定义势函数 $h_u = dist(s, u)$，对于一条边 $(u, v)$ 将其边权修改为 $cost(u, v) + h_u - h_v$，显然非负，接下来都跑 Dijkstra，并更新势函数。

## 上下界费用流

### 最小费用无源汇有上下界可行流

同无源汇有上下界可行流

### 最小费用有源汇有上下界可行流

建边 $(t, s, \infty, 0)$，跑最小费用无源汇有上下界可行流

### 最小费用有上下界最大流

一定保证「不存在源到汇的负权路径」。跟去掉「费用」的差不多嘛，无非是记得构建残量网络的时候带上边的费用。

# 技巧

- 顶点限流：拆点
- 多源多汇：super $S$ & $T$！
- 费用分段递增：拆边
- 非此即彼：二分图，跑完后和源还是汇连通表示这个点选择了哪个
- 退流：有时你会碰到这样一类问题：跑完网络流后加减一丢丢边，询问新的最大流。

  如果是加边，加进去直接在原来跑完的基础上继续跑；

  如果是减边，假设要删去边 $(u, v)$，从 $u$ 到 $S$ 跑最大流，从 $T$ 到 $v$ 跑最大流，再将 $(u, v)$ 及其反向边流量置为 $0$，就算是退流了，然后再跑从 $S$ 到 $T$ 的最大流。

  退流也可以应用于费用流。
- 输出方案，一般采取「若没有这条边的情况下跑得的最大流比有这条边的最大流小一，则该边要割」的策略。
- 当前弧优化：老生常谈，非常有用，「一道退流题被当前弧优化水过去了」，常有的事。

# 应用

## 最大权闭合子图

[Jump!](https://imilyx.github.io/2020/12/26/%E3%80%90%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E3%80%91%E6%9C%80%E5%A4%A7%E6%9D%83%E9%97%AD%E5%90%88%E5%AD%90%E5%9B%BE/)

## 最大密度子图

给定正点权、正边权的有向图 $(V, E)$，求一个子图使得边权与点权的比值尽量大。

选了边就必须选点，所以分数规划 + 边建点，跑最大权闭合子图。

## 混合图欧拉路径、回路

**先判断底图连通性**

随便定向，再利用网络流来判断能否使得流量平衡，即 $\forall x, d_x = in_x - out_x = 0$。

- 对于原图可以反向的边 $(u, v)$，连边 $(v, u, 2)$，表示反向 $(u, v)$ 可以使得 $d_u + 2$, $d_v - 2$
- 若 $d_u$ 应该 $+ x$，则连边 $(u, t, x)$
- 若 $d_u$ 应该 $- x$，则连边 $(s, u, x)$

若与 $s$、$t$ 相连的边全部满流，则有解。输出方案就将 $(v, u, 2)$ 满流的 $(u, v)$ 反向。

## 区间 $k$ 覆盖

要求任意**一个点**至多被 $k$ 个区间覆盖。

转化为左闭右开区间。

- 连边 $(s, 1, k, 0)$
- 设端点为 $1$ ~ $m$，连边 $(i, i + 1, \infty, 0)$
- 设区间 $[u, v)$ 权值为 $w$，连边 $(u, v, 1, w)$

## DAG 最小路径覆盖问题

[Jump!](https://imilyx.github.io/2020/12/27/%E3%80%90%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E3%80%91%E6%9C%80%E9%95%BF%E5%8F%8D%E9%93%BE%E5%92%8C%E5%AE%83%E5%85%A8%E5%AE%B6%EF%BC%88%E8%AF%A6%E7%BB%86%E6%8F%AD%E7%A7%98%EF%BC%89/)

# 习题

## [机场Airport](https://loj.ac/p/2403)

**真 正 的 题 意**：一架 $x$ 人的飞机进行一次移动产生 $x * p$ 的代价。一架飞机在登机时若出现在坏的停机坪上则产生 $x$ 的代价。摆渡车好像是无限的？

「你一开始都坏了就别动了吧！」基于这样的思想，坏的停机坪可以看作无限。而飞机分三种：

- 一直好，代价 $0$
- 出身好，第二天就坏了，代价 $x * p$
- 一直坏，代价 $x$

把登机和起飞时间点离散化，共有 $2n$ 个时间点。画一张 $a * 2n$ 的表格，表示每块好停机坪的使用情况。那么一架登机 $l$ 起飞 $r$ 的飞机，前两种决策分别为：

- 占用 $[l, r)$
- 占用 $[l, l + 1)$

但是实际不可能建出表格，考虑压成 $1 * 2n$，类似于区间 $k$ 覆盖——每列（每格）不超过 $a$。要保证两个决策不同时进行，还得把飞机拆点咯。

点数 $3n + 1$, 边数 $5n$，流量上限 $a$。primal-dual, 第一次用 dp 计算。

[$Code(Dij)$](https://loj.ac/s/1067724) 
[$Code(Spfa)$](https://loj.ac/s/1067716)

~~Dij 还是快的啊~~

## 无限之环

[Jump!](http://imilyx.github.io/2020/08/06/%5B%E6%B8%85%E5%8D%8E%E9%9B%86%E8%AE%AD2017%5D-%E6%97%A0%E9%99%90%E4%B9%8B%E7%8E%AF/)

## [$Parametric\ Circulation$](https://www.luogu.com.cn/problem/CF925F)

有循环流等价于最大流 = 源点连出边的容量和。最大流是一个关于 $t$ 的分段一次函数，而且是凸的。合法答案一定是一段连续区间，二分即可。

**这题卡精度超严重，dinic 里必须写 used，写 rest 就疯狂 WA on 28，令人摸不着头发。**

[$Code$](https://codeforces.com/contest/925/submission/107931638)

## [$Son\ of\ pipe\ streams$](https://loj.ac/p/6479)

流量平衡且流过每条管道的水和油总量不超过管道容量。

求出最大流 $X$，设最优方案中水流 $w$，油流 $f$，$|w| + |f| = |X|$。$|f|^a(|X| - |f|)^{1 - a}$，最大值在 $|f| = a * X$ 时取到。注意，设最大水流 $W$，最大油流 $F$，$|f|$ 有隐藏限制区间 $[|X| - |W|, |F|]$。

考虑怎么构造方案：求出每条边在最优方案中流过的水油和，（此时无向边被定向了），对每条边限制其容量为流过的水油和，求出其中大小为 $|f|$ 的一个油流，显然剩下存在大小为 $|X| - |f| = |w|$ 的水流。

注意初始时边是无向的，边和反向边的容量均为 $C_i$。

[$Code$](https://loj.ac/s/1070112)

---

感谢学长们绝妙的讲授和课件！

~~写完都不认得「流」了 (|||o_o)~~